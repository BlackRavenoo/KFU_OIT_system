# Frontend часть системы управления заявками ЕИ КФУ
Актуально для v0.0.55

[![Test frontend](https://github.com/BlackRavenoo/KFU_OIT_system/actions/workflows/test.yaml/badge.svg)](https://github.com/BlackRavenoo/KFU_OIT_system/actions/workflows/test.yaml)
![Code Coverage](https://img.shields.io/badge/Coverage-99.33%25-brightgreen)

## Технологический стек

- **Фреймворк**: SvelteKit
- **Язык программирования**: TypeScript
- **Стилизация**: VanillaCSS
- **Сборщик**: Vite
- **Управление состоянием**: Svelte stores
- **API взаимодействие**: Fetch API (внутренняя обертка)
- **Маршрутизация**: Встроенная маршрутизация SvelteKit
- **Тестирование**: Vitest

## Структура проекта

Структура директорий клиентской части:

```
www/
├── build/            # Сборка для продакшена (генерируется автоматически)
├── src/              # Исходный код приложения
│   ├── app.html      # Базовый HTML шаблон
│   ├── assets/       # Статические ресурсы
│   ├── lib/          # Библиотеки и компоненты многократного использования
│   │   ├── components/    # Переиспользуемые компоненты
│   │   │   ├── Captcha/   # Компоненты для работы с капчей
│   │   │   ├── Footer/    # Компонент футера
│   │   │   ├── Modal/     # Модальные окна
│   │   │   ├── Nav/       # Навигационная панель
│   │   │   └── Search/    # Строка поиска и модуль пагинации
│   │   └── utils/         # Утилиты и вспомогательные функции
│   │       ├── account/   # Функции личного кабинета пользователя
│   │       ├── admin/     # Функции панели администратора
│   │       │   ├── statistics  # Функции статистики администратора
│   │       ├── auth/      # Функции для авторизации
│   │       │   ├── api/        # API для авторизации
│   │       │   ├── storage/    # Хранение данных авторизации
│   │       │   └── tokens/     # Работа с токенами авторизации
│   │       ├── captcha/   # Функции для работы с капчей
│   │       ├── files/     # Работа с файлами
│   │       ├── notifications/ # Система уведомлений
│   │       ├── pages/ # Функции для взаимодействия с базой знаний
│   │       ├── setup/     # Базовые функции первичной настройки приложения
│   │       ├── texteditor/ # Редактор документов для базы знаний
│   │       ├── tickets/   # Функции для работы с заявками
│   │       │   └──  api/        # API для работы с заявками
│   │       └── validation/   # Функции для валидации значений
│   └── routes/       # Маршруты/страницы приложения
│       ├── account/             # Страница личного кабинета
│       │   └── components/      # Вкладки личного кабинета
│       ├── autoauth/            # Страница автоматической авторизации (для внешних переходов)
│       ├── confirm/             # Страница подтверждения регистрации
│       ├── contact/             # Страница контактов
│       ├── error/               # Страница обработки специфичных ошибок
│       ├── faq/                 # Страница FAQ
│       ├── privacy/             # Политика конфиденциальности
│       ├── reset/               # Страница сброса пароля
│       ├── texteditor/          # Редактор документов для базы знаний
│       ├── ticket/              # Страница отдельной заявки
│       │   └── [id]/            # Динамический маршрут по ID заявки
│       ├── tickets/             # Страница списка заявок
│       ├── +error.svelte        # Страница ошибок
│       ├── +layout.js           # Глобальная логика
│       ├── +layout.svelte       # Общий шаблон страниц
│       └── +page.svelte         # Главная страница
├── tests/            # Тесты (соответствует структуре src/)
├── .env              # Переменные окружения (не включены в репозиторий)
├── .env.example      # Пример файла с переменными окружения
├── package.json      # Зависимости и скрипты проекта
├── svelte.config.js  # Конфигурация Svelte
├── tsconfig.json     # Конфигурация TypeScript
├── vite.config.ts    # Конфигурация Vite
└── vitest.config.ts  # Конфигурация Vitest
```

## Установка и запуск

### Требования

- Node.js
- npm || pnpm

### Установка зависимостей

Для установки зависимостей используйте следующие команды:
```sh
npm install
# Или
pnpm install
```

### Запуск в режиме разработки

Для запуска в режиме разработки:

```sh
npm run dev
```

### Сборка для продакшена

Для создания продакшен-сборки:

```sh
npm run build
```

### Быстрая сборка без тестов

Для создания продакшен-сборки:

```sh
npm run build:no-test
```

### Hot-reload сервер для Docker

Для автоматической пересборки клиенсткой части в запущенном Docker контейнере во время разработки:

```sh
npm run watch:build
```

## Переменные окружения

Создайте файл .env на основе .env.example и заполните необходимые переменные:

- VITE_CAPTCHA_KEY - Публичный ключ для капчи Lemin (если используется)

## Логика работы

### Инициализация приложения

1. При загрузке приложение инициализирует хранилище токенов в +layout.js
2. Проверяется наличие сохраненного токена авторизации
3. Если токен есть, приложение пытается его обновить
4. На основе успешности авторизации обновляются store-ы isAuthenticated и currentUser
5. Загружаются константы и глобальные настройки приложения

### Обработка запросов

1. Запросы к API обрабатываются через утилиты в папке src/lib/utils
2. Каждый запрос автоматически добавляет токен авторизации, если он существует
3. Ошибки авторизации (401) автоматически обрабатываются с попыткой обновления токена
4. При неудачном обновлении токена пользователь перенаправляется главную страницу с запуском logout
5. Все запросы включают обработку ошибок и уведомления пользователя

### Управление состоянием

1. Глобальное состояние управляется через Svelte store-ы
   - currentUser - информация о текущем пользователе
   - isAuthenticated - состояние авторизации
   - pageTitle - заголовок текущей страницы
   - pageDescription - описание текущей страницы для метатегов
2. Локальное состояние компонентов хранится в их собственных переменных
3. Данные, сохраняемые в localStorage (или иные внешние хранилища, если это предусмотрено реализацией)
   - auth_state - флаг для сохранения состояние аутентификации пользователя между мессиями
   - auth_tokens - access и refresh токены для сохранения авторизации между сессиями и запросов к API
   - auth_user - данные пользователя
   - ticketsFilter - выбранные параметры отображения тикетов на странице заявок
   - Кеш повторяющихся запросов